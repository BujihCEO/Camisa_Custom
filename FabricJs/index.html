<!DOCTYPE html>
<html lang="en" style="font-size: calc(1 * 62.5%);">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="assets/index.css">
    <link rel="stylesheet" type="text/css" href="assets/custom_base.css">
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <script src="assets/potrace.js"></script>
    <script src="assets/jscolor.js"></script>
    <title>index</title>
</head>
<body>
    <div class="previewWrap"></div>
</body>
<script src="assets/index.js"></script>
<script>

var setPrintArea = [
    {
        area: {   
            node: frontPrint,
            name: 'Frente',
            add: [
                {
                    image: {
                        position: {},
                        mask: {
                            url: 'assets/BG_In_Love_Front.svg',
                            fill: '#ff0000',
                            jsColor: '#ff0000',
                        },
                    }
                },
                {
                    tittle: 'Grade de fotos',
                    image: {
                        position: {
                            height: 2000,
                            width: 2000,
                        },
                        upload: { 
                            type: '', 
                            fill: '#ff0000',
                            jsColor: '#ff0000',
                            add: [
                                {x: 0, y: 0, w: 1000, h: 1000},
                                {x: 1000, y: 0, w: 1000, h: 1000},
                                {x: 0, y: 1000, w: 1000, h: 1000},
                                {x: 1000, y: 1000, w: 1000, h: 1000},
                            ],
                        },
                    } 
                },
                {
                    tittle: 'Foto',
                    image: {
                        position: {
                            x: 0,
                            y: 0,
                            height: 2000,
                            width: 2000,
                        },
                        upload: { 
                            type: '', 
                            fill: '#ff0000',
                            jsColor: '#ff0000',
                            add: [
                                {x: 0, y: 0, w: 1000, h: 1000},
                                {x: 1000, y: 0, w: 1000, h: 1000},
                                {x: 0, y: 1000, w: 1000, h: 1000},
                                {x: 1000, y: 1000, w: 1000, h: 1000},
                            ],
                        },
                    } 
                },
            ]
        }
    },

    {
        area: { 
            node: backPrint,
            name: 'Costa',
            add: [
                {

                },
            ]
        }
    },
];

var editList = [];
var btnList = [];
for (var [index, item] of setPrintArea.entries()) {
    if (item.area.node) {
        let a = item.area;
        let p = a.node.getParent();
        let btn = document.createElement('button');
        btn.textContent = a.name;
        btnList.push(btn);
        popupBtnWrap.appendChild(btn);
        let edit = document.createElement('div');
        edit.className = 'customBox';
        editList.push(edit);
        mainEdit.appendChild(edit);
        btn.addEventListener('click', () => {
            btnList.forEach((e, i) => {
                dragOff();
                if (e === btn) {
                    e.classList.add('selected');
                    editList[i].classList.remove('hidden');
                    setPrintArea[i].area.node.getParent().show();
                } else {
                    e.classList.remove('selected');
                    editList[i].classList.add('hidden');
                    setPrintArea[i].area.node.getParent().hide();
                }
            });
        });

        setTimeout( ()=> {
            setPreviews(p, canvasPreview);
        }, 1000);

        if (index === 0) {
            btn.classList.add('selected');
        } else { 
            p.hide();
            edit.classList.add('hidden'); 
        }
        
        if (a.add) {
            a.add.forEach((e) => {
                var box = document.createElement('div');
                var tittle = document.createElement('div');
                tittle.className = 'tittle';
                tittle.textContent = e.tittle;
                box.appendChild(tittle);
                edit.appendChild(box);
                if (e.image) {
                    var att = e.image;
                    var width = att.position.width ? att.position.width : a.node.width();
                    var height = att.position.height ? att.position.height : a.node.height();
                    
                    var group = new Konva.Group({
                        width: width,
                        height: height,
                        x: att.position.x ? att.position.x : (a.node.width() / 2) - (width / 2),
                        y: att.position.y ? att.position.y : (a.node.height() / 2) - (height / 2),
                        clip: {
                            width: width,
                            height: height,
                        },
                    });
                    a.node.add(group);

                    if (att.upload) {
                        var upBox = document.createElement('div');
                        upBox.className = 'imageBox';
                        box.appendChild(upBox);
                        var input = document.createElement('input');
                        input.className = 'inputImage';
                        input.type = 'file';
                        input.accept = 'image/*';
                        upBox.appendChild(input);
                        
                        var configBox = document.createElement('div');
                        configBox.className = 'configBox hidden';

                        var changeImg = document.createElement('div');
                        changeImg.className =  'changeImg iconBox';
                        changeImg.addEventListener('click', ()=> {
                            input.click();
                        });                        
                        changeImg.span = document.createElement('span');
                        changeImg.span.textContent = 'Mudar imagem';
                        changeImg.appendChild(changeImg.span);
                        configBox.appendChild(changeImg);

                        var callEditor = document.createElement('div');
                        callEditor.className = 'callEditor iconBox';
                        callEditor.addEventListener('click', ()=> {
                            adjShow();
                        });
                        callEditor.span = document.createElement('span');
                        callEditor.span.textContent = 'Editar';
                        callEditor.appendChild(callEditor.span);
                        configBox.appendChild(callEditor);

                        if (att.upload.add) {
                            var add = att.upload.add;
                            var multi = add.length > 1 ? true : false;

                            if (multi) {
                                var boxPositions = document.createElement('div');
                                boxPositions.className = 'boxPositions';
                                boxPositions.style.aspectRatio = `${width}/${height}`;
                                upBox.appendChild(boxPositions);
    
                                for (let i = 0; i < add.length; i++) {
                                    var position = document.createElement('div');
                                    position.style = `
                                        left: ${(add[i].x / width) * 100}%; 
                                        top: ${(add[i].y / height) * 100}%; 
                                        width: ${(add[i].w / width) * 100}%; 
                                        height: ${(add[i].h / height) * 100}%;
                                        color: #${colorOrder[i]}
                                    `;
                                    boxPositions.appendChild(position);
                                }
                            }

                            var iconsBox = document.createElement('div');
                            iconsBox.className = `iconsBox slider ${multi? 'multi': ''}`;
                            upBox.appendChild(iconsBox);

                            for (let i = 0; i < add.length; i++) {
                                let div = document.createElement('div');

                                let imgIcon = document.createElement('div');
                                imgIcon.className = 'addImage';
                                imgIcon.input = true;
                                imgIcon.parent = div;
                                imgIcon.configBox = configBox;
                                iconPlace.push(imgIcon);
                                div.appendChild(imgIcon);

                                if (multi) {
                                    let color = document.createElement('span');
                                    color.style.color = `#${colorOrder[i]}`;
                                    div.appendChild(color);
                                }

                                let konvaBox = new Konva.Group({
                                    width: add[i].w,
                                    height: add[i].h,
                                    x: add[i].x,
                                    y: add[i].y,
                                    clip: {
                                        width: add[i].w,
                                        height: add[i].h,
                                    },
                                });
                                
                                imgPlace.push(konvaBox);

                                group.add(konvaBox);

                                imgIcon.onClick = (verify = false)=> {
                                    console.log(verify);
                                    if (verify) {
                                        if (imgIcon.input === true) {
                                            if (iconPlace.selected) {
                                                iconPlace.selected.parent.classList.remove('selected');
                                                iconPlace.selected.configBox.classList.add('hidden');
                                            }
                                            imgIcon.parent.classList.add('selected');
                                            imgIcon.configBox.classList.add('hidden');
                                            iconPlace.selected = imgIcon;
                                            imgPlace.selected = konvaBox;
                                            nodeTarget = undefined;
                                            transformer.nodes([]);
                                            transformer.hide();
                                            input.click();
                                            console.log(1);
                                        } else {
                                            if (iconPlace.selected === imgIcon) {
                                                dragOff();
                                                console.log(2);
                                            } else {
                                                dragOn(konvaBox.getChildren()[0]);
                                                console.log(3);
                                            }
                                        }
                                    } else {
                                        if (iconPlace.selected === imgIcon) {
                                            iconPlace.selected.parent.classList.remove('selected');
                                            iconPlace.selected.configBox.classList.add('hidden');
                                            iconPlace.selected = undefined;
                                            imgPlace.selected = undefined;
                                            console.log(4);
                                        } else {
                                            if (iconPlace.selected) {
                                                iconPlace.selected.parent.classList.remove('selected');
                                                iconPlace.selected.configBox.classList.add('hidden');
                                            }
                                            imgIcon.parent.classList.add('selected');
                                            imgIcon.configBox.classList.remove('hidden');
                                            iconPlace.selected = imgIcon;
                                            imgPlace.selected = konvaBox;
                                            console.log(5);
                                        }
                                    }
                                }
                                
                                imgIcon.onclick = ()=> {
                                    imgIcon.onClick(true);
                                }

                                iconsBox.appendChild(div);
                            }

                        }

                        upBox.appendChild(configBox);

                        if (att.upload.type === 'svg') {
                            input.addEventListener('change', function(event) {
                                NewPotrace(event, att.upload.fill, group, (image) => {
                                    createJsColor(box, target = [image], att.upload.jsColor);
                                });
                            });
                        }
    
                        if (!att.upload.type) {
                            input.addEventListener('change', function(event) {
                                upload(event, imgPlace.selected, iconPlace.selected);
                                iconPlace.selected.input = false;
                            });
                        }
                        
                    }

                    if (att.mask) {
                        var att = att.mask;
                        if (att.url) {
                            getPath(att.url, group, att.fill)
                            .then(path => {
                                path.setAttrs({
                                    id: 'path',
                                    listening: false,
                                });
                                if (att.jsColor) {
                                    createJsColor(box, target = [path], att.jsColor);
                                }
                            })
                        }
                    }
                }
            });
        }

    }
}

</script>
<script src="assets/custom_base.js"></script>
</html>
